"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _mongodb=require("mongodb"),_bcryptjs=_interopRequireDefault(require("bcryptjs")),_nodemailer=_interopRequireDefault(require("nodemailer")),_User=_interopRequireDefault(require("../../../models/User")),_mongoose=_interopRequireDefault(require("../../../lib/mongoose")),_uuid=require("uuid"),_dotenv=_interopRequireDefault(require("dotenv"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}_dotenv.default.config();var verificationCode=(0,_uuid.v4)(),transporter=_nodemailer.default.createTransport({service:"gmail",auth:{user:process.env.EMAIL_USERNAME,pass:process.env.EMAIL_PASSWORD}});function handler(r,t){var a,s,n,o,i,u,l,c,d;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if("POST"!==r.method){e.next=34;break}if(console.log(r.body),a=r.body,s=a.email,n=a.name,o=a.password,i=a.retype,n&&"string"==typeof n){e.next=5;break}return e.abrupt("return",t.status(422).json({message:"Please provide a valid name"}));case 5:if(u=s.toLowerCase().trim(),l=n.toLowerCase().trim(),u&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(u)){e.next=9;break}return e.abrupt("return",t.status(422).json({message:"Please enter a correct email address"}));case 9:if(o!==i)return e.abrupt("return",t.status(422).json({message:"Passwords do not match"}));e.next=11;break;case 11:return e.next=13,regeneratorRuntime.awrap(_bcryptjs.default.hash(o,10));case 13:return c=e.sent,e.prev=14,e.next=17,regeneratorRuntime.awrap(_User.default.findOne({email:u}));case 17:if(e.sent)return e.abrupt("return",t.status(400).json({success:!1,message:"User already exists"}));e.next=20;break;case 20:return e.next=22,regeneratorRuntime.awrap(_User.default.create({name:l,email:s,password:c,role:"user"}));case 22:return d=e.sent,console.log(d),e.next=26,regeneratorRuntime.awrap(sendVerificationEmail(u,verificationCode));case 26:t.status(201).json({success:!0,data:d,message:"Signed up! A verification email has been sent to your email address"}),e.next=32;break;case 29:e.prev=29,e.t0=e.catch(14),t.status(500).json({message:"User not created",error:e.t0.message});case 32:e.next=35;break;case 34:t.status(405).json({success:!1,message:"Method not allowed"});case 35:case"end":return e.stop()}},null,null,[[14,29]])}function sendVerificationEmail(r,t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(transporter.sendMail({from:'"Retrogold" <pelumiilupeju@gmail.com>',to:r,subject:"Verify Your Email",text:"Please click the link below to verify your email:\nhttp://your-app.com/verify-email?code=".concat(t),html:'<b>Please click the link below to verify your email:</b><br><a href="http://your-app.com/verify-email?code='.concat(t,'">Verify Email</a>')}));case 3:console.log("Verification email sent successfully"),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),console.error("Error sending verification email:",e.t0);case 9:case"end":return e.stop()}},null,null,[[0,6]])}(0,_mongoose.default)();var _default=handler;exports.default=_default;
//# sourceMappingURL=register.min.js.map
